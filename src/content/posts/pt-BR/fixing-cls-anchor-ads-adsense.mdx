export const meta = {
	title:
		'Como corrigir o Cumulative Layout Shift nos an√∫ncios de √¢ncora do Adsense',
	author: 'Matheus Francisco',
	description:
		'O Google come√ßou a adotar an√∫ncios de √¢ncora no Adsense (FINALMENTE!!!), mas ele move a p√°gina para baixo e causa muito CLS',
	date: '2021-10-12'
};

# Corrigindo o Cumulative Layout Shift (CLS) nos an√∫ncios de √¢ncora do Adsense

Recentemente, o Google nos presenteou mais uma vez com an√∫ncios de √¢ncora (ou anchor ads, ou an√∫ncios fixos, se preferir) no Adsense
e realizou os nossos (ou o meu, pelo menos) infinitos desejos de colocar an√∫ncios fixos na p√°gina sem quebrar nenhuma pol√≠tica.

...Mas ele insere um padding-top no body e causa layout shift. üò†

![cls](/images/content/posts/fixing-cls-anchor-ads-adsense/cls.png)

## O que √© Cumulative Layout Shift?

Cumulative Layout Shift √© uma m√©trica que mede o quanto do layout muda inesperadamente.
Em outras palavras, resumidamente, √© quando um elemento da p√°gina muda de posi√ß√£o ou de tamanho,
sem que o usu√°rio tenha interagido com a p√°gina para que isso tenha acontecido.

Al√©m de ser uma m√©trica que mede o qu√£o irritado seu usu√°rio est√° com as coisas dan√ßando aleat√≥riamente na sua p√°gina,
CLS tamb√©m √© uma m√©trica do [Core Web Vitals](https://web.dev/vitals/) (Principais m√©tricas da web),
do qual o Google come√ßou a usar como um dos quesitos de ranqueamento.

## Ent√£o... o que est√° acontecendo?

Percebi que eu estava recebendo uma nota horr√≠vel de CLS e percebi que s√≥ os an√∫ncios de √¢ncora j√° causavam 0.19 de CLS
(sendo que CLS acima de 0.25 √© ruim).
Ent√£o verifiquei que os an√∫ncios de √¢ncora adicionavam um padding-top na tag body com o tamanho correspondente ao tamaho do an√∫ncio,
a medida que o usu√°rio rolasse a p√°gina:

![Adsense adicionando padding-top ao scrollar](/images/content/posts/fixing-cls-anchor-ads-adsense/body-padding.gif)

E ele n√£o s√≥ move o conte√∫do todo pra baixo, como tamb√©m deixa esse espa√ßo esquisito acima do cabe√ßalho:
![](/images/content/posts/fixing-cls-anchor-ads-adsense/ad-above-header.png)

## Como corrigir?

Primeiro de tudo, voc√™ precisa considerar que
[voc√™ pode desabilitar os an√∫ncios de ficarem fixos no topo da p√°gina](https://support.google.com/adsense/answer/7478225?hl=pt). Mas de acordo com o Google:

> Nossa experi√™ncia mostra que os an√∫ncios √¢ncora apresentam melhor desempenho na parte superior da tela do usu√°rio.

N√£o soa bem, a melhor solu√ß√£o que eu encontrei foi remover esses estilos assim que s√£o inseridos.
Voc√™ pode fazer isso com o [MutationObserver](https://developer.mozilla.org/pt-BR/docs/Web/API/MutationObserver):

```javascript
document.addEventListener('DOMContentLoaded', () => {
	const body = document.body;
	const observer = new MutationObserver(() => {
		body.style.padding = '';
	});
	observer.observe(body, {
		attributes: true,
		attributeFilter: ['style']
	});
});
```

O que isso faz √©:

1. Quando instanciamos o MutationObserver, passamos uma fun√ß√£o de callback que ser√° chamada para cada muta√ß√£o no DOM.
   Nesse caso, n√≥s criamos uma fun√ß√£o que limpa o padding do body.
2. Ent√£o, n√≥s observamos sempre que houver alguma muta√ß√£o nos atributos do body, mais especificamente filtrando apenas o atributo style.
3. Por fim, colocamos isso tudo dentro de um event listener que executa quando o documento est√° carregado e pronto.

Perceba que, levando em considera√ß√£o a usabilidade, quando voc√™ voltar ao topo da p√°gina,
voc√™ deve fornecer um jeito do an√∫ncio n√£o ficar em cima do seu cabe√ßalho.
Para isso, eu recomendo que voc√™ cheque se o an√∫ncio est√° presente:

```javascript
const isAdDisplayed = !!document.querySelector(
	"ins.adsbygoogle[data-ad-status='filled'][data-anchor-shown='true'][data-anchor-status='displayed']"
);
```

E se est√° e o scroll est√° no topo da p√°gina,
adicione um `position: relative;` ou `position: fixed;` no cabe√ßalho e mova-o para baixo com `top: ...px;`.

Para outro tipos de an√∫ncio, voc√™ pode ler o pr√≥prio guia do Adsense de [como minimizar o layout shift](https://developers.google.com/publisher-tag/guides/minimize-layout-shift).

√â isso! Obrigado por ler üòâ
